---
title: "Tutorial for fine-mapping with functional priors"
author: Kaixuan Luo, Alan Selewa
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE)
```

In this tutorial, we perform fine-mapping (using SuSiE) with 
functional priors computed from the enrichment analysis using `TORUS`.

Load the packages. 
```{r load-package}
library(mapgen)
```

## Input data

Please see the [data preparation tutorial][data-preparation-tutorial] about 
preparing GWAS summary statistics. 

We need a `bigSNP` object for the reference genotype panel, 
which will be used for computing LD matrices. See the 
[data preparation tutorial][data-preparation-tutorial] for details.

## SNP-level priors

Let's load the processed GWAS summary statistics obtained from 
the [data preparation tutorial][data-preparation-tutorial] and the 
SNP-level priors using `run_torus()` obtained from the [enrichment analysis tutorial][enrichment-tutorial].
```{r}
gwas.sumstats <- readRDS(system.file('extdata', 'test.processed.sumstats.rds', package='mapgen'))
torus.res <- readRDS(system.file('extdata', 'test.torus.res.rds', package='mapgen'))
```

Now, we can add the SNP-level priors to our summary statistics. 
```{r add-torus-priors}
gwas.sumstats <- prepare_susie_data_with_torus_result(sumstats = gwas.sumstats, 
                                                      torus_prior = torus.res$snp_prior)
```

We see we have a new column called 'torus_prior'.
```{r}
head(as.data.frame(gwas.sumstats), 3)
```

We did not filter loci in this tutorial example. 
You could limit loci with GWAS p-value cutoff (e.g. 5e-8), 
or by FDR cutoff from running `run_torus()` with `option = "fdr"`. 

## Fine-mapping

We can then perform fine-mapping with SNP-level priors using `SuSiE`, 
you will need the `susieR` and `bigsnpr` packages for the steps below. 
```{r, message=FALSE}
library(susieR)
library(bigsnpr)
```

To use SNP-level priors computed from `TORUS`, we use `run_finemapping()` 
with `priortype = 'torus'`.
```{r run-susie-torus-prior, eval=FALSE, message=FALSE}
susie.finemap.res <- run_finemapping(sumstats = gwas.sumstats, 
                                     bigSNP = bigSNP, 
                                     priortype = 'torus', 
                                     L = 1)
```

`susie.finemap.res` is a list of `SuSiE` results, one for each locus. 

We ran `SuSiE` with `L = 1`, which allows a single causal signal for 
each LD block and is robust to mismatching LD patterns.

You can also run fine-mapping using uniform prior (without SNP-level priors)
with `priortype = 'uniform'`. _(You don't need to run `TORUS` if you run 
fine-mapping using uniform prior.)_

We can merge GWAS summary statistics with SuSiE result:
```{r merge-susie-sumstats, eval=FALSE}
finemap.sumstats <- merge_susie_sumstats(susie.finemap.res, gwas.sumstats)
```

We now have a new column called `susie_pip` which is the probability of a SNP 
being causal estimated using `SuSiE`.

```{r, include=FALSE}
finemap.sumstats <- readRDS(system.file('extdata', 'test.finemap.sumstats.rds', package='mapgen'))
```

```{r}
head(as.data.frame(finemap.sumstats),3)
```

[data-preparation-tutorial]: https://xinhe-lab.github.io/mapgen/articles/data_preparation_tutorial.html
[enrichment-tutorial]: https://xinhe-lab.github.io/mapgen/articles/enrichment_finemapping_tutorial.html
